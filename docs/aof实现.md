# AOF持久化实现
## 实现原理方案
redis aof持久化支持三种模式:always,everysec,no

appendfsync配置|解释
---|---
always|aof_buf缓冲区所有内容写入并同步到aof文件
everysec|aof_buf缓冲区所有内容写入aof文件，如果距离上一次同步文件超过1s,则将同步aof文件，该操作由另外一个线程负责
no|aof_buf缓冲区所有内容写入aof文件，但不对aof文件同步由系统决定何时同步

为了简单实现，这里仅实现always。aof保存的为操作redis的所有写操作，例如：set,sadd,incr等。

aof格式为：
```

```

aof主要包含三个部分：
1. 持久化aof文件
2. 载入aof文件
3. 重写aof文件

## 实现方案
### 持久化aof文件
实现思路：对客户端写事件，将该数据保存到aof_buf中，
### 载入aof文件
**redis实现思路**：程序启动先检查是否存在aof文件，如果存在，则创建一个fake client，读取aof文件，
然后利用伪客户端发送读取的命令。一直重复直至读取文件结束。

**本项目实现思路**：程序启动先检查是否存在aof文件，如果存在，读取aof文件，调用函数执行set操作。一直重复直至读取文件结束。

### 重写aof文件
1. 遍历db,根据不同数据类型，转换成resp协议，生成的数据写成temp文件
2. 重写过程命令写入aof缓存区,aof重写缓存区，待文件重写完成，原子替换原有aof文件
3. 将aof重写缓存区中的数据写入到新生成的aof文件中

为了避免堵塞服务器处理命令，重写过程会在子进程中执行。